ItemTypeMap = {
    book1 = {
        "book_rocky",     --石虾
        "book_pigman",    --猪人
        "book_bunnyman",  --兔人
        "book_krampus",   --坎普斯
        "book_tentacles", --触手
        "book_birds",
        "book_meteor",
        "book_sleep",
        "book_brimstone"
    },
    book2 = {
        "book_minotaur",          --犀牛
        "book_deerclops",         --巨鹿
        "book_moose",             --鸭子
        "book_dragonfly",         --龙蝇
        "book_bearger",           --熊大
        "book_spiderqueen",       --蜘蛛女王
        "book_leif",              --树精
        "book_touch_leif",        --点树成精
        "book_touch_spiderqueen", --点蛛成精
        "book_animal_breed",      --生物繁殖书
        "book_grow_spiderden",    --蜘蛛生长
    },
    book3 = {
        "book_clear",           --清理书
        "book_harvest",         --收获书
        "book_pickup",          --拾取书
        "book_seeder",          --播种书
        "book_hatch",           --孵化书
        "book_gardening",       --应用园艺学
        "book_incubate",        --应用孵化学
        "book_pisciculture",    --应用渔业学
        "book_pigman_golden",   --猪人点金
        "book_bunnyman_golden", --兔人点金
        "book_golden_rocky",    --黄金石虾
        "book_touch_golden",    --点怪成金书
        "book_seeder_golden",   --黄金播种书
    },
    golden_food = TaxueList.golden_food,
    gem = {
        "redgem",        --红
        "bluegem",       --蓝
        "purplegem",     --紫
        "greengem",      --绿
        "orangegem",     --橙
        "yellowgem",     --黄
        "pink_gem",      --粉宝石
        "cyan_gem",      --青宝石
        "white_gem",     --白宝石
        "black_gem",     --黑宝石
        "taxue_diamond", --钻石

        "random_gem",    --随机宝石
        "promote_gem",   --提升宝石
        "reset_gem",     --重置宝石
        "colorful_gem",  --五彩宝石
        "copy_gem",      --复制宝石
    },
    equipment = TaxueList.equipment,
    my_ticket = TaxueList.my_ticket,
    egg_all = {
        "taxue_egg_nomal",
        "taxue_egg_moose",
        "taxue_egg_doydoy",
        "taxue_egg_tallbird",
        "taxue_egg_colourful",
        "taxue_egg_golden",
        "taxue_egg_sakura",
        "taxue_egg_lacy",
        "taxue_egg_taxue",
        "taxue_egg_totoro",
        "taxue_egg_spotty",
        "taxue_egg_wave",
        "taxue_egg_star",
        "taxue_egg_grassland",
        "taxue_egg_lightning",
        "taxue_egg_whiteblue",
        "taxue_egg_strawberry",
        "taxue_egg_pineapple",
        "taxue_egg_lollipop",
        "taxue_egg_starrysky",
        "taxue_egg_tigershark",
        "taxue_egg_charm",
        "taxue_egg_eddy",
        "taxue_egg_txxm",
        "taxue_egg_hatch",
        "taxue_egg_delicious",
        "taxue_egg_porcelain",
        "taxue_egg_rainbow",
        "taxue_egg_lava",
        "taxue_egg_decorate",
        "taxue_egg_harvest",
        "taxue_egg_lollipop_rare",
        "taxue_egg_ancient",
        "taxue_egg_skin",
        "taxue_egg_melon",
        "taxue_egg_rock",
        "taxue_egg_meteor",
        "taxue_egg_millionclub",
        "taxue_egg_rose",
        "taxue_egg_ampullaria_gigas",
        "taxue_egg_free",
    },
    treasure_map = TaxueList.treasure_map,
    weapon1 = TaxueList.weapon,
    weapon2 = TaxueList.weapon2,
    armor1 = TaxueList.armor,
    armor2 = TaxueList.armor_2,
    key = {

        "corkchest_key",     --软木桶钥匙
        "treasurechest_key", --木箱钥匙
        "skullchest_key",    --骨钥匙
        "pandoraschest_key", --精致钥匙
        "minotaurchest_key", --豪华钥匙
        "terrarium_key",     --恐怖钥匙
        "poison_key",        --剧毒钥匙
    },
    agentia_all = {
        "exp_agentia",             --经验药剂-蓝
        "health_agentia",          --血量药剂-红
        "sanity_agentia",          --san值药剂-绿
        "ice_agentia",             --寒冰药剂
        "hot_agentia",             --炎热药剂
        "map_agentia",             --开心
        "treasure_agentia",        --寻宝
        "totoro_agentia",          --龙猫
        "transfer_agentia",        --随机传送
        "light_agentia",           --发光药剂

        "antivenom_agentia",       --解毒药剂
        "sleep_agentia",           --催眠药水
        "invisible_agentia",       --隐形药水
        "taxue_milk",              --牛奶

        "golden_agentia_pigman",   --点金猪人
        "golden_agentia_bunnyman", --点金兔人
        "scared_agentia",          --恐惧药剂
        "mocking_agentia",         --嘲讽药剂
        "awake_agentia",           --唤醒药剂
        "lessen_agentia",          --缩小药剂
        "paralytic_agentia",       --麻痹药剂
        "bleed_agentia",           --流血药剂
        "weak_agentia",            --虚弱药剂
        "rage_agentia",            --狂暴药剂
        "illegal_cooking_oil",     --地沟油
        "bramble_agentia",         --荆棘药剂
        "bloodsucking_agentia",    --嗜血药剂
    },
    essence = {
        "plant_essence",         --植物精华
        "sea_essence",           --海洋精华
        "volcano_essence",       --火山精华
        "threecolor_essence",    --三色精华
        "delicious_essence",     --美味精华
        "roe_essence",           --鱼籽精华
        "pearl_essence",         --珍珠精华
        "spiderhat_essence",     --蜘蛛帽精华
        "mineral_essence",       --矿石精华
        "mushroom_essence",      --蘑菇精华
        "ice_essence",           --寒冰精华
        "return_fresh_essence",  --反鲜精华
        "free_essence",          --白嫖精华
        "free_essence_advanced", --高级白嫖精华
        "chest_essence",         --宝箱精华
        "chest_essence_nomal"    --稀有宝箱精华
    },
    special = {
        "perpetual_core",     --永动机核心
        "crystal_ball_taxue", --水晶煤球
        "random_agentia",     --随机药剂
        "chest_agentia",      --宝箱药剂
    },
}

ItemTypeNameMap = {
    book1 = "低级书",
    book2 = "高级书",
    book3 = "功能书",
    golden_food = "黄金食物",
    gem = "宝石",
    equipmentHigh = "高属性五彩装备",
    equipmentLow = "低属性五彩装备",
    my_ticket = "劵类",
    egg_all = "孵化蛋",
    treasure_map = "藏宝图",
    weapon1 = "低级武器",
    weapon2 = "高级武器",
    armor1 = "低级装备",
    armor2 = "高级装备",
    key = "钥匙",
    agentia_all = "药水",
    essence = "精华",
    special = "特殊",
    others = "其他"
}

---count table
---@param table table
---@return integer
TableCount = function(table)
    local count = 0
    for _, _ in pairs(table) do count = count + 1 end
    return count
end

local function giveItem(inst, item)
    local owner = inst.components.inventoryitem.owner
    if owner then
        local container = owner == GetPlayer() and owner.components.inventory or owner.components.container
        if container:CanTakeItemInSlot(item) then
            container:GiveItem(item)
            return
        end
    end
    local pos = Vector3(inst.Transform:GetWorldPosition())
    item.Transform:SetPosition(pos:Get())
    item.components.inventoryitem:OnDropped(true)
end

local function getStackedItem(name, amount, maxsize)
    local items = {}
    if not maxsize then
        local tempItem = SpawnPrefab(name)
        maxsize = tempItem.components.stackable.maxsize
        tempItem:Remove()
    end
    local size = amount or 1
    local stack_num = math.floor(size / maxsize)
    local surplus_num = size - maxsize * stack_num
    if stack_num > 0 then
        for i = 1, stack_num do
            local newItem = SpawnPrefab(name)
            newItem.components.stackable.stacksize = maxsize
            table.insert(items, newItem)
        end
    end
    if surplus_num > 0 then
        local newItem = SpawnPrefab(name)
        newItem.components.stackable.stacksize = surplus_num
        table.insert(items, newItem)
    end
    return items
end

local function addToList(list, entity, number)
    local amount = 1
    local name = entity
    if type(entity) == "string" then
        amount = number or 1
    else
        name = entity.prefab
        amount = entity.components.stackable and entity.components.stackable.stacksize or 1
    end
    if type(entity) == "string" or entity.components.stackable then
        if list[name] then
            list[name] = list[name] + amount
        else
            list[name] = amount
        end
    else
        list[name] = list[name] or {}
        local data = entity:GetSaveRecord()
        table.insert(list[name], data)
    end
end

local function processPackageData(package, itemType, amount, value)
    package.amount = package.amount or 0
    if package.hasValue == nil then package.hasValue = true end
    package.amountIndex = package.amountIndex or {}
    package.amountIndex[itemType] = package.amountIndex[itemType] or 0
    package.valueMap = package.valueMap or {}
    package.valueMap[itemType] = package.valueMap[itemType] or { hasValue = true, value = 0 }

    package.amount = amount and package.amount + amount or package.amount
    package.amountIndex[itemType] = amount and package.amountIndex[itemType] + amount or package.amountIndex[itemType]

    package.hasValue = package.hasValue and (value ~= nil)
    package.valueMap[itemType].hasValue = package.valueMap[itemType].hasValue and (value ~= nil)
    package.valueMap[itemType].value = value and package.valueMap[itemType].value + value or package.valueMap[itemType].value

    if package.hasValue then
        package.taxue_coin_value = package.taxue_coin_value and package.taxue_coin_value + value or value
    else
        package.taxue_coin_value = nil
    end
end

---spawn a super package
---@param name? string package display name
---@param type? string|nil package type
---@return table package
function SpawnPackage(name, type)
    local package = SpawnPrefab("super_package")
    package.isPatched = true
    package.name = name or package.name
    package.type = type
    package.amount = 0
    package.amountIndex = {}
    package.hasValue = true
    package.valueMap = {}
    return package
end

---transform package to patched package
---@param package table
---@return table newPackage
function TransformPackage(package)
    if package.isPatched then return package end

    local slots = package.components.container.slots
    local newPackage = SpawnPackage()
    for _, v in pairs(slots) do
        AddItemToSuperPackage(newPackage, v)
    end
    for k, v in pairs(package.item_list) do
        if type(v) == "table" then
            for name, items in pairs(v) do
                if type(items) == "number" then
                    local item = SpawnPrefab(name)
                    item.components.stackable.stacksize = items
                    AddItemToSuperPackage(newPackage, item)
                else
                    for _, data in ipairs(items) do
                        local item = SpawnSaveRecord(data)
                        AddItemToSuperPackage(newPackage, item)
                    end
                end
            end
        else
            local newItem = SpawnPrefab(k)
            newItem.components.stackable.stacksize = v
            AddItemToSuperPackage(newPackage, newItem)
        end
    end
    if TableCount(newPackage.item_list) == 1 then
        for type, _ in pairs(newPackage.item_list) do
            newPackage.type = type
        end
    end
    local owner = package.components.inventoryitem.owner
    if owner then
        newPackage.components.inventoryitem.owner = owner
        local slots
        if owner == GetPlayer() then
            slots = owner.components.inventory.itemslots
        else
            slots = owner.components.container.slots
        end
        for i, slot in pairs(slots) do
            if slot == package then
                slots[i] = newPackage
            end
        end
    else
        newPackage.Transform:SetPosition(Vector3(package.Transform:GetWorldPosition()):Get())
    end
    package:Remove()
    return newPackage
end

---merge two packages into one
---@param package table
---@param packageM table
---@return table package
function MergePackage(package, packageM)
    if not package.isPatched then package = TransformPackage(package) end
    if not packageM.isPatched then packageM = TransformPackage(packageM) end
    if packageM.amount == 0 then return package end
    package.hasValue = package.hasValue and packageM.hasValue ~= false
    if package.hasValue then
        package.taxue_coin_value = package.taxue_coin_value and packageM.taxue_coin_value and package.taxue_coin_value + packageM.taxue_coin_value or package.taxue_coin_value or
            packageM.taxue_coin_value
    else
        package.taxue_coin_value = nil
    end
    local item_list = package.item_list
    for typeName, list in pairs(packageM.item_list) do
        item_list[typeName] = item_list[typeName] or {}
        package.valueMap = package.valueMap or {}
        package.valueMap[typeName] = package.valueMap[typeName] or { hasValue = true, value = 0 }
        package.valueMap[typeName].hasValue = package.valueMap[typeName].hasValue and packageM.valueMap[typeName].hasValue ~= false
        package.valueMap[typeName].value = package.valueMap[typeName].value and package.valueMap[typeName].value + packageM.valueMap[typeName].value or packageM.valueMap[typeName].value or 0
        for itemName, number in pairs(list) do
            local amount
            if type(number) == "table" then
                item_list[typeName][itemName] = item_list[typeName][itemName] or {}
                local i = 0
                for _, v in ipairs(number) do
                    table.insert(item_list[typeName][itemName], v)
                    i = i + 1
                end
                amount = i
            else
                amount = number
                item_list[typeName][itemName] = item_list[typeName][itemName] and item_list[typeName][itemName] + amount or amount
            end
            package.amount = package.amount and package.amount + amount or amount
            package.amountIndex = package.amountIndex or {}
            package.amountIndex[typeName] = package.amountIndex[typeName] and package.amountIndex[typeName] + amount or amount
        end
    end
    packageM:Remove()
    return package
end

---将物品添加到超级包裹
---@param package table
---@param entity table
---@param showFx? boolean
function AddItemToSuperPackage(package, entity, showFx)
    --特效
    if showFx then SpawnPrefab("small_puff").Transform:SetPosition(entity.Transform:GetWorldPosition()) end
    --fx.Transform:SetScale(0.5,0.5,0.5)
    if not package.isPatched then
        package = TransformPackage(package)
        if not package then return end
    end

    local item_list = package.item_list
    if entity.prefab == "super_package" then
        MergePackage(package, entity)
        return
    end
    local added = false
    local itemType
    for type, list in pairs(ItemTypeMap) do
        if table.contains(list, entity.prefab) then
            if type == "equipment" then
                local isHigh = entity.equip_value >= TaxuePatch.cfg.HIGH_EQUIPMENT_PERCENT * entity.MAX_EQUIP_VALUE
                type = isHigh and "equipmentHigh" or "equipmentLow"
            end
            if not item_list[type] then
                item_list[type] = {}
            end
            addToList(item_list[type], entity)
            itemType = type
            added = true
            break
        end
    end
    if not added then
        if not item_list.others then
            item_list.others = {}
        end
        local list = item_list.others
        addToList(list, entity)
        itemType = "others"
    end

    local amount = entity.components.stackable and entity.components.stackable.stacksize or 1
    local coinValue = entity.taxue_coin_value and entity.taxue_coin_value * amount
    processPackageData(package, itemType, amount, coinValue)

    entity:Remove()
end

---打开超级包裹
---@param package table
---@return table|nil
function UnpackSuperPackage(package)
    if package.isPatched then
        if package.amount == 0 then return nil end
        local item_list = package.item_list
        if not package.type then
            for itemType, list in pairs(item_list) do
                local typeName = ItemTypeNameMap[itemType]
                local newPackage = SpawnPackage()
                newPackage.name = typeName
                newPackage.type = itemType
                newPackage.amount = package.amountIndex[itemType]
                newPackage.amountIndex = newPackage.amountIndex or {}
                newPackage.amountIndex[itemType] = package.amountIndex[itemType]
                newPackage.hasValue = package.valueMap[itemType].hasValue
                newPackage.valueMap = newPackage.valueMap or {}
                newPackage.valueMap[itemType] = package.valueMap[itemType]
                newPackage.taxue_coin_value = newPackage.hasValue and package.valueMap[itemType] and package.valueMap[itemType].value or nil
                newPackage.item_list[itemType] = list
                giveItem(package, newPackage)
            end
        else
            local list = package.item_list[package.type]
            local maxAmount = TaxuePatch.cfg.PACKAGE_MAX_AMOUNT
            local isSingle = TableCount(list) == 1
            for name, items in pairs(list) do
                local itemList = {}
                if type(items) == "number" then
                    local tempItem = SpawnPrefab(name)
                    local maxsize = tempItem.components.stackable.maxsize
                    tempItem:Remove()
                    itemList = getStackedItem(name, items, maxsize)
                else
                    for _, item in pairs(items) do
                        table.insert(itemList, SpawnSaveRecord(item))
                    end
                end
                local itemNum = #itemList
                if itemNum > maxAmount * 1.5 then
                    local packageName = TaxueToChs(name)
                    local packageType = package.type
                    local newPackage = SpawnPackage(packageName, packageType)
                    local i = 0
                    for _, item in ipairs(itemList) do
                        if isSingle then
                            if i >= maxAmount and itemNum - i > maxAmount / 2 then
                                giveItem(package, newPackage)
                                newPackage = SpawnPackage(packageName, packageType)
                                itemNum = itemNum - i
                                i = 0
                            end
                            i = i + 1
                        end
                        AddItemToSuperPackage(newPackage, item)
                    end
                    giveItem(package, newPackage)
                else
                    for _, item in pairs(itemList) do
                        giveItem(package, item)
                    end
                end
            end
        end
    else
        TransformPackage(package)
    end
    package:Remove()
end

---删除容器内物品
---@param container table
---@param itemList table[]
function RemoveSlotsItems(container, itemList)
    for slot, _ in pairs(itemList) do
        container:RemoveItemBySlot(slot):Remove()
    end
end

---售货亭卖东西
---@param inst table
function SellPavilionSellItems(inst)
    local container = inst.components.container
    local slots = container.slots

    local diamond = nil
    local playSound = false
    local coinList = {}
    local coins = 0
    for slot, item in pairs(slots) do
        local amount = 1
        if item and item.components.stackable then
            amount = item.components.stackable.stacksize
        end
        if item and item.taxue_coin_value then
            --物品价值
            local taxue_coin_value = item.taxue_coin_value
            --有耐久，根据耐久百分比替换价值
            if item.components.finiteuses then
                local percent = item.components.finiteuses:GetPercent()
                taxue_coin_value = taxue_coin_value * percent
            end
            --有护甲值
            if item.components.armor then
                local percent = item.components.armor:GetPercent()
                taxue_coin_value = taxue_coin_value * percent
            end

            coins = coins + taxue_coin_value * amount

            --移除物品
            container:RemoveItemBySlot(slot):Remove()
        elseif item and item.prefab == "taxue_coin" then
            coinList[slot] = item
        elseif item and item.prefab == "taxue_coin_silver" then
            coinList[slot] = item
        elseif item and item.prefab == "taxue_coin_copper" then
            coinList[slot] = item
        elseif item and TaxuePatch.cfg.SELL_PAVILION == "bank" and item.prefab == "taxue_diamond" then
            diamond = item
        end
    end
    print("总硬币价值：", coins)
    local tempCoins = 0
    for slot, coin in pairs(coinList) do
        local amount = coin.components.stackable.stacksize
        if coin.prefab == "taxue_coin" then
            tempCoins = tempCoins + amount * 100
        elseif coin.prefab == "taxue_coin_silver" then
            tempCoins = tempCoins + amount
        elseif coin.prefab == "taxue_coin_copper" then
            tempCoins = tempCoins + amount * 0.01
        end
    end

    --如果是银行模式并且有钻石,存银行
    if diamond and coins + tempCoins > 0 then
        container:RemoveItem(diamond):Remove()
        RemoveSlotsItems(container, coinList)
        GetPlayer().bank_value = GetPlayer().bank_value + (coins + tempCoins) / 100
        playSound = true
        --如果不是禁用,并且金额大于500梅币
    elseif TaxuePatch.cfg.SELL_PAVILION and coins + tempCoins >= 50000 then
        RemoveSlotsItems(container, coinList)
        local goldBrick = SpawnPrefab("gold_brick")
        goldBrick.taxue_coin_value = coins + tempCoins
        container:GiveItem(goldBrick)
        playSound = true
        --否则,生成梅币
    else
        local gold = math.floor(coins / 100)
        coins = coins - gold * 100
        local silver = math.floor(coins)
        local copper = math.floor((coins - silver) * 100 + 0.5)

        TaxueGiveItem(inst, "taxue_coin", gold)          --刷金币
        TaxueGiveItem(inst, "taxue_coin_silver", silver) --刷银币
        TaxueGiveItem(inst, "taxue_coin_copper", copper) --刷铜币

        if gold + silver + copper > 0 then
            playSound = true
        end
    end
    if playSound then inst.SoundEmitter:PlaySound("money/sfx/money") end
end

---开宝藏
---@param treasures table[]
---@return table loots
function OpenTreasure(treasures)
    treasures[1].SoundEmitter:PlaySound("dontstarve_DLC002/common/loot_reveal")

    local treasure = treasures[1]
    local number = TableCount(treasures)
    local loots = { boneshard = 2 * number }
    loots["obsidian"] = 0
    local lootTable = LootTables[treasure.prefab]
    local obsidianTimes = treasure.components.workable.workleft
    local chanceChest = 0
    local chanceStatue = 0
    local chest

    for i = 1, obsidianTimes * number do
        if math.random() <= 0.2 then
            loots["obsidian"] = loots["obsidian"] + 1
        end
    end

    for _, treasure in pairs(treasures) do
        for _, entry in ipairs(lootTable) do
            local prefab = entry[1]
            local chance = entry[2]
            if math.random() <= chance then
                table.insert(loots, prefab)
            end
        end

        local books = { "book_tentacles", "book_birds", "book_meteor", "book_sleep", "book_brimstone", "book_gardening",
            "book_tentacles", "book_birds", "book_meteor", "book_sleep", "book_brimstone" }                               --原版书籍
        local statue = { "ruins_statue_head", "ruins_statue_head_nogem", "ruins_statue_mage", "ruins_statue_mage_nogem" } --远古雕像
        if math.random() <= 0.1 then
            SpawnPrefab(books[math.random(#books)])
        end

        if treasure.prefab == "taxue_buriedtreasure_monster" then --怪物宝藏
            local str = treasure.advance_list[1] or "spider"
            local monster = SpawnPrefab(str)
            if monster then
                monster.Transform:SetPosition(treasure.Transform:GetWorldPosition())
            end
            treasure:Remove()
            return loots
        end

        if treasure.prefab == "taxue_buriedtreasure" then
            chanceChest = 0.5
            chanceStatue = 0.2
            chest = "taxue_treasurechest"
        elseif treasure.prefab == "taxue_buriedtreasure_luxury" then
            chanceChest = 0.3
            chanceStatue = 0.3
            chest = "taxue_pandoraschest"
        end

        if math.random() <= chanceChest then
            local chest = SpawnPrefab(chest)
            for __, v in ipairs(treasure.advance_list) do
                local item = SpawnPrefab(v)                                                                        --预制表内的物品
                if item ~= nil then
                    chest.components.container:GiveItem(item)                                                      --刷物品进箱子
                end
            end                                                                                                    --添加物品
            chest.Transform:SetPosition(treasure.Transform:GetWorldPosition())                                     --生成花栗箱子
        elseif math.random() <= chanceStatue then
            SpawnPrefab(statue[math.random(#statue)]).Transform:SetPosition(treasure.Transform:GetWorldPosition()) --生成随机雕像
        end
        treasure:Remove()
    end
    return loots
end
